<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - PixelLumo</title>
    <script src="base-path.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="components-loader.js"></script>
</head>
<body class="auth-page">
<div class="auth-container fade-in">
    <div class="login-header">
        <h1 class="glow">&#127918; PixelLumo</h1>
        <p>Create New Password</p>
    </div>

    <div id="messageContainer" class="error-message"></div>

    <form id="resetPasswordForm">
        <div class="form-group">
            <label for="newPassword">New Password:</label>
            <div class="password-input-group">
                <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password" required minlength="6">
                <button type="button" class="password-toggle" id="toggleNewPassword">
                    üëÅÔ∏è
                </button>
            </div>
        </div>

        <div class="form-group">
            <label for="confirmPassword">Confirm Password:</label>
            <div class="password-input-group">
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password" required minlength="6">
                <button type="button" class="password-toggle" id="toggleConfirmPassword">
                    üëÅÔ∏è
                </button>
            </div>
        </div>

        <button type="submit" class="auth-button">Reset Password</button>
    </form>

    <div class="auth-link">
        <a href="login.html">Back to Login</a>
    </div>
</div>

<script src="auth-service.js"></script>
<script src="utils.js"></script>
<script>
    const messageContainer = document.getElementById('messageContainer');
    const form = document.getElementById('resetPasswordForm');

    // Get token from URL
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');

    if (!token) {
        messageContainer.textContent = '‚ùå Invalid or missing reset token. Request a new password reset.';
        messageContainer.style.display = 'block';
        form.style.display = 'none';
    } else {
        // Verify token
        fetch(`${API_BASE}/api/verify-reset-token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
        })
            .then(res => res.json())
            .then(data => {
                if (data.valid) {
                    form.style.display = 'block';
                } else {
                    messageContainer.textContent = `‚ùå ${data.error || 'Reset token is invalid or expired.'}`;
                    messageContainer.style.display = 'block';
                    form.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageContainer.textContent = '‚ùå Error verifying reset token.';
                messageContainer.style.display = 'block';
                form.style.display = 'none';
            });
    }

    // Password visibility toggles
    document.getElementById('toggleNewPassword').addEventListener('click', (e) => {
        e.preventDefault();
        const input = document.getElementById('newPassword');
        const btn = document.getElementById('toggleNewPassword');
        input.type = input.type === 'password' ? 'text' : 'password';
        btn.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
    });

    document.getElementById('toggleConfirmPassword').addEventListener('click', (e) => {
        e.preventDefault();
        const input = document.getElementById('confirmPassword');
        const btn = document.getElementById('toggleConfirmPassword');
        input.type = input.type === 'password' ? 'text' : 'password';
        btn.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            messageContainer.textContent = '‚ùå Passwords do not match.';
            messageContainer.className = 'error-message';
            messageContainer.style.display = 'block';
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/api/reset-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, newPassword })
            });

            if (!response.ok) {
                const error = await response.json();
                messageContainer.textContent = `‚ùå ${error.error || 'Failed to reset password'}`;
                messageContainer.className = 'error-message';
                messageContainer.style.display = 'block';
                return;
            }

            messageContainer.textContent = '‚úÖ Password reset successfully! Redirecting to login...';
            messageContainer.className = 'success-message';
            messageContainer.style.display = 'block';
            form.style.display = 'none';
            
            setTimeout(() => {
                window.location.href = window.APP_BASE + 'index.html';
            }, 2000);
        } catch (error) {
            console.error('Error:', error);
            messageContainer.textContent = '‚ùå Error resetting password. Please try again.';
            messageContainer.className = 'error-message';
            messageContainer.style.display = 'block';
        }
    });
</script>
</body>
</html>
