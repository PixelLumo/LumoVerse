<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings&#127918; PixelLumo</title>
    <script src="base-path.js"></script>
    <link rel="stylesheet" href="style.css" id="style-link">
    <script src="auth.js"></script>
    <script src="nav-loader.js"></script>
    <script src="components-loader.js"></script>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-content">
    <h1 class="glow">&#127918; PixelLumo</h1>
  </div>
  
  <!-- NAVIGATION - Loaded from nav.html -->
  <nav></nav>
</header>

<main>
    <div class="settings-container fade-in">
        <div class="settings-header">
            <h1>‚öôÔ∏è Settings</h1>
            <p>Manage your account and preferences</p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <!-- Profile Edit Section -->
        <div class="profile-edit-section">
            <h2>üë§ Edit Profile</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label for="profileUsername">Username</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="profileUsername" placeholder="Your username">
                        <button type="button" class="btn-primary" style="padding: 12px 20px; white-space: nowrap;" onclick="changeUsername()">Change</button>
                    </div>
                    <small style="color: #999; margin-top: 5px; display: block;">Choose a new username (3-20 characters, letters, numbers, underscores, hyphens only)</small>
                </div>

                <div class="form-group">
                    <label for="profileEmail">Email Address</label>
                    <input type="email" id="profileEmail" placeholder="your@email.com" readonly>
                    <small style="color: #999; margin-top: 5px; display: block;">Email address is locked</small>
                </div>

                <div class="form-group">
                    <label for="profileBio">Bio</label>
                    <textarea id="profileBio" placeholder="Tell others about yourself..."></textarea>
                </div>

                <div class="form-group">
                    <label for="profileFavGame">Favorite Game</label>
                    <input type="text" id="profileFavGame" placeholder="Your favorite game">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save Changes</button>
                    <button type="button" class="btn-secondary" onclick="resetProfileForm()">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Privacy Settings Section -->
        <div class="settings-section">
            <h2>üîí Privacy & Security</h2>
            
            <div class="setting-item">
                <div class="setting-label">
                    <strong>Public Profile</strong>
                    <small>Allow others to view your profile</small>
                </div>
                <div class="setting-control">
                    <button class="toggle-switch active" id="publicProfile" onclick="toggleSetting('publicProfile')"></button>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <strong>Allow Private Messages</strong>
                    <small>Let other users send you direct messages</small>
                </div>
                <div class="setting-control">
                    <button class="toggle-switch active" id="allowMessages" onclick="toggleSetting('allowMessages')"></button>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <strong>Show Achievements</strong>
                    <small>Display your gaming achievements</small>
                </div>
                <div class="setting-control">
                    <button class="toggle-switch active" id="showAchievements" onclick="toggleSetting('showAchievements')"></button>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <strong>Email Notifications</strong>
                    <small>Receive email updates</small>
                </div>
                <div class="setting-control">
                    <button class="toggle-switch active" id="emailNotif" onclick="toggleSetting('emailNotif')"></button>
                </div>
            </div>
        </div>

        <!-- Display Settings Section -->
        <div class="settings-section">
            <h2>üé® Display & Theme</h2>
            
            <div class="setting-item">
                <div class="setting-label">
                    <strong>Dark Mode</strong>
                    <small>Currently enabled</small>
                </div>
                <div class="setting-control">
                    <button class="toggle-switch active" id="darkMode" onclick="toggleSetting('darkMode')" disabled></button>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <strong>Compact View</strong>
                    <small>Use compact layout on pages</small>
                </div>
                <div class="setting-control">
                    <button class="toggle-switch" id="compactView" onclick="toggleSetting('compactView')"></button>
                </div>
            </div>
        </div>

        <!-- Account Settings Section -->
        <div class="settings-section">
            <h2>üîê Account Management</h2>
            
            <div class="setting-item">
                <div class="setting-label">
                    <strong>Change Password</strong>
                    <small>Update your password regularly</small>
                </div>
                <div class="setting-control">
                    <button class="btn-settings" onclick="showChangePassword()">Change</button>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <strong>Two-Factor Authentication</strong>
                    <small>Add extra security to your account</small>
                </div>
                <div class="setting-control">
                    <button class="btn-settings" id="twoFactorBtn" onclick="toggleTwoFactor()">Enable</button>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-label">
                    <strong>Logout All Sessions</strong>
                    <small>End all active sessions across devices</small>
                </div>
                <div class="setting-control">
                    <button class="btn-settings" style="background: #ff6b6b;" onclick="logoutAllSessions()">Logout All</button>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="settings-section" style="border-color: #ff6b6b; background: rgba(255, 107, 107, 0.05);">
            <h2 style="color: #ff6b6b;">‚ö†Ô∏è Danger Zone</h2>
            
            <div class="setting-item">
                <div class="setting-label">
                    <strong>Delete Account</strong>
                    <small>Permanently delete your account and all data</small>
                </div>
                <div class="setting-control">
                    <button class="btn-settings" style="background: #ff6b6b;" onclick="deleteAccount()">Delete</button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- FOOTER -->
<footer>
  <div class="footer-content">
    <p>&copy; 20&#127918; PixelLumo - Gaming Community</p>
  </div>
</footer>

<script src="auth.js"></script>
<script src="nav-loader.js"></script>
<script src="storage-service.js"></script>
<script>
    // Load user profile data
    function loadProfileData() {
        const currentUser = getCurrentUser();
        if (!currentUser) {
            window.location.href = window.APP_BASE + 'index.html';
            return;
        }

        document.getElementById('profileUsername').value = currentUser.username;
        document.getElementById('profileEmail').value = currentUser.email;

        // Load saved profile data from localStorage
        const savedProfile = localStorage.getItem('userProfile_' + currentUser.username);
        if (savedProfile) {
            const profile = JSON.parse(savedProfile);
            document.getElementById('profileBio').value = profile.bio || '';
            document.getElementById('profileFavGame').value = profile.favGame || '';
        }

        // Load settings from localStorage
        loadSettings();
    }

    function loadSettings() {
        const currentUser = getCurrentUser();
        const settingsKey = 'userSettings_' + currentUser.username;
        const settings = JSON.parse(localStorage.getItem(settingsKey)) || {};

        document.getElementById('publicProfile').classList.toggle('active', settings.publicProfile !== false);
        document.getElementById('showAchievements').classList.toggle('active', settings.showAchievements !== false);
        document.getElementById('emailNotif').classList.toggle('active', settings.emailNotif !== false);
        document.getElementById('compactView').classList.toggle('active', settings.compactView === true);
    }

    function saveSettings() {
        const currentUser = getCurrentUser();
        const settingsKey = 'userSettings_' + currentUser.username;
        const settings = {
            publicProfile: document.getElementById('publicProfile').classList.contains('active'),
            showAchievements: document.getElementById('showAchievements').classList.contains('active'),
            emailNotif: document.getElementById('emailNotif').classList.contains('active'),
            compactView: document.getElementById('compactView').classList.contains('active')
        };
        localStorage.setItem(settingsKey, JSON.stringify(settings));
    }

    function toggleSetting(id) {
        const element = document.getElementById(id);
        if (element.id === 'darkMode') return; // Dark mode is locked

        element.classList.toggle('active');

        // Handle allowMessages with API call
        if (id === 'allowMessages') {
            const allow = element.classList.contains('active');
            updateAllowMessages(allow);
        } else {
            saveSettings();
            showStatusMessage('Settings updated!', 'success');
        }
    }

    async function updateAllowMessages(allow) {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE}/api/user/allow-messages`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ allow_messages: allow })
            });

            if (!response.ok) {
                throw new Error('Failed to update setting');
            }

            showStatusMessage(allow ? 'Private messages enabled' : 'Private messages disabled', 'success');
        } catch (error) {
            console.error('Error updating messaging setting:', error);
            // Revert toggle
            document.getElementById('allowMessages').classList.toggle('active');
            showStatusMessage('Failed to update setting', 'error');
        }
    }

    function changeUsername() {
        const newUsername = document.getElementById('profileUsername').value.trim();
        const currentUser = getCurrentUser();

        // Validation
        if (!newUsername) {
            showStatusMessage('Username cannot be empty', 'error');
            return;
        }

        if (newUsername === currentUser.username) {
            showStatusMessage('New username is the same as current username', 'error');
            return;
        }

        if (newUsername.length < 3) {
            showStatusMessage('Username must be at least 3 characters', 'error');
            return;
        }

        if (newUsername.length > 20) {
            showStatusMessage('Username must be 20 characters or less', 'error');
            return;
        }

        if (!/^[a-zA-Z0-9_-]+$/.test(newUsername)) {
            showStatusMessage('Username can only contain letters, numbers, underscores, and hyphens', 'error');
            return;
        }

        // Check if username already exists in email map
        const emailMap = JSON.parse(localStorage.getItem('pixellumo_emailMap') || '{}');
        for (let email in emailMap) {
            if (emailMap[email].toLowerCase() === newUsername.toLowerCase()) {
                showStatusMessage('Username already taken', 'error');
                return;
            }
        }

        // Update email-to-username mapping
        const oldUsername = currentUser.username;
        emailMap[currentUser.email.toLowerCase()] = newUsername;
        localStorage.setItem('pixellumo_emailMap', JSON.stringify(emailMap));

        // Migrate user account data (user_${username})
        const oldUser = localStorage.getItem('user_' + oldUsername);
        if (oldUser) {
            const userData = JSON.parse(oldUser);
            userData.username = newUsername;
            localStorage.setItem('user_' + newUsername, JSON.stringify(userData));
            localStorage.removeItem('user_' + oldUsername);
        }

        // Migrate user profile data
        const oldProfile = localStorage.getItem('userProfile_' + oldUsername);
        if (oldProfile) {
            localStorage.setItem('userProfile_' + newUsername, oldProfile);
            localStorage.removeItem('userProfile_' + oldUsername);
        }

        // Migrate user settings
        const oldSettings = localStorage.getItem('userSettings_' + oldUsername);
        if (oldSettings) {
            localStorage.setItem('userSettings_' + newUsername, oldSettings);
            localStorage.removeItem('userSettings_' + oldUsername);
        }

        // Migrate user achievements
        const oldAchievements = localStorage.getItem('userAchievements_' + oldUsername);
        if (oldAchievements) {
            localStorage.setItem('userAchievements_' + newUsername, oldAchievements);
            localStorage.removeItem('userAchievements_' + oldUsername);
        }

        // Migrate user posts
        const oldPosts = localStorage.getItem('userPosts_' + oldUsername);
        if (oldPosts) {
            localStorage.setItem('userPosts_' + newUsername, oldPosts);
            localStorage.removeItem('userPosts_' + oldUsername);
        }

        // Migrate user following list
        const oldFollowing = localStorage.getItem('userFollowing_' + oldUsername);
        if (oldFollowing) {
            localStorage.setItem('userFollowing_' + newUsername, oldFollowing);
            localStorage.removeItem('userFollowing_' + oldUsername);
        }

        // Update user session with new username
        currentUser.username = newUsername;
        sessionStorage.setItem('pixellumo_user', JSON.stringify(currentUser));
        localStorage.setItem('pixellumo_remember', JSON.stringify(currentUser));

        showStatusMessage('Username changed successfully! Page will refresh...', 'success');
        setTimeout(() => {
            location.reload();
        }, 2000);
    }

    function resetProfileForm() {
        loadProfileData();
    }

    document.getElementById('profileForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const currentUser = getCurrentUser();
        const profile = {
            bio: document.getElementById('profileBio').value,
            favGame: document.getElementById('profileFavGame').value
        };
        localStorage.setItem('userProfile_' + currentUser.username, JSON.stringify(profile));
        showStatusMessage('Profile updated successfully!', 'success');
    });

    function showChangePassword() {
        alert('Password change feature will be implemented soon!');
    }

    function toggleTwoFactor() {
        alert('Two-factor authentication feature will be implemented soon!');
    }

    function logoutAllSessions() {
        if (confirm('Are you sure? You will be logged out on all devices.')) {
            logoutUser();
        }
    }

    function deleteAccount() {
        if (confirm('Are you sure? This action cannot be undone. All your data will be permanently deleted.')) {
            if (confirm('Type DELETE to confirm account deletion.')) {
                const currentUser = getCurrentUser();
                // Clear user data
                localStorage.removeItem('pixellumo_user');
                localStorage.removeItem('pixellumo_remember');
                localStorage.removeItem('userProfile_' + currentUser.username);
                localStorage.removeItem('userSettings_' + currentUser.username);
                sessionStorage.removeItem('pixellumo_user');
                
                alert('Account deleted. Redirecting to home...');
                window.location.href = window.APP_BASE + 'home.html';
            }
        }
    }

    function showStatusMessage(message, type) {
        const statusElement = document.getElementById('statusMessage');
        statusElement.textContent = message;
        statusElement.className = `status-message ${type}`;
        
        setTimeout(() => {
            statusElement.className = 'status-message';
        }, 3000);
    }

    // Load profile on page load
    window.addEventListener('load', loadProfileData);
</script>
<script src="scripts.js"></script>
</body>
</html>
